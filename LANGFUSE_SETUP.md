# Langfuse Integration Guide

## –ß—Ç–æ —ç—Ç–æ –¥–∞—ë—Ç?

Langfuse –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è:
- üìä **–¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è LangGraph** ‚Äî –≤–∏–¥–∏—Ç–µ –∫–∞–∂–¥—ã–π —É–∑–µ–ª –≥—Ä–∞—Ñ–∞ –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
- üí∞ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–æ–∏–º–æ—Å—Ç–∏** ‚Äî –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç –Ω–∞ Gemini API (–ø–æ —Ç–æ–∫–µ–Ω–∞–º)
- ‚è±Ô∏è **–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** ‚Äî –Ω–∞—Ö–æ–¥–∏—Ç–µ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞ (–º–µ–¥–ª–µ–Ω–Ω—ã–µ —É–∑–ª—ã, –¥–æ–ª–≥–∏–µ –≤—ã–∑–æ–≤—ã)
- üîç **–û—Ç–ª–∞–¥–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤** ‚Äî –∏–Ω—Å–ø–µ–∫—Ü–∏—è –≤—Ö–æ–¥–æ–≤/–≤—ã—Ö–æ–¥–æ–≤ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞
- üìà **A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

## –ß—Ç–æ —Ç—Ä–∞—Å—Å–∏—Ä—É–µ—Ç—Å—è?

### 1. **LangGraph execution** (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ callback)
- –í—Å–µ —É–∑–ª—ã –≥—Ä–∞—Ñ–∞: `prepare_context`, `chunk_notes`, `build_search_query`, `exa_search`, `compose_prompt`, `call_gemini`, `post_process`
- –ü–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —É–∑–ª–∞–º–∏ –∏ —É—Å–ª–æ–≤–∏—è –≤–µ—Ç–≤–ª–µ–Ω–∏—è
- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ

### 2. **Gemini API calls**
- –ü—Ä–æ–º–ø—Ç—ã –∏ –æ—Ç–≤–µ—Ç—ã (—É—Å–µ—á—ë–Ω–Ω—ã–µ –¥–æ 1000 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞)
- –û—Ü–µ–Ω–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ (–ø—Ä–∏–º–µ—Ä–Ω–∞—è: 4 —Å–∏–º–≤–æ–ª–∞ ‚âà 1 —Ç–æ–∫–µ–Ω)
- –ú–æ–¥–µ–ª—å, timeout, —Ä–µ–∂–∏–º (text/stream)
- Latency

### 3. **Exa search**
- –ó–∞–ø—Ä–æ—Å—ã –ø–æ–∏—Å–∫–∞
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—ç—à–∞
- Host, —è–∑—ã–∫, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ

### 4. **RAG operations**
- **Upsert**: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤ –≤ –∏–Ω–¥–µ–∫—Å (host, URL, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞–Ω–∫–æ–≤)
- **Retrieve**: –ø–æ–∏—Å–∫ –ø–æ –∏–Ω–¥–µ–∫—Å—É (–∑–∞–ø—Ä–æ—Å, top-k, scores)
- –†–∞–∑–º–µ—Ä –∏–Ω–¥–µ–∫—Å–∞ –∏ –º–µ—Ç—Ä–∏–∫–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏

## –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?

### 1. **–ü—Ä–æ—Å–º–æ—Ç—Ä traces –≤ Langfuse**

–ü–æ—Å–ª–µ –∑–∞–ø—Ä–æ—Å–∞ –≤ Chrome-—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–∏:
1. –û—Ç–∫—Ä–æ–π—Ç–µ [cloud.langfuse.com](https://cloud.langfuse.com) (–∏–ª–∏ —Å–≤–æ–π self-hosted)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª **Traces**
3. –ù–∞–π–¥–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π trace –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∏–ª–∏ URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã
4. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ trace, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å:
   - **Timeline**: –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∞ –∏ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ —É–∑–ª–∞
   - **Generations**: –≤—Å–µ –≤—ã–∑–æ–≤—ã Gemini —Å –ø—Ä–æ–º–ø—Ç–∞–º–∏ –∏ –æ—Ç–≤–µ—Ç–∞–º–∏
   - **Spans**: Exa search –∏ RAG –æ–ø–µ—Ä–∞—Ü–∏–∏
   - **Metadata**: –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ (URL, title, force_search)

### 2. **–ê–Ω–∞–ª–∏–∑ —Å—Ç–æ–∏–º–æ—Å—Ç–∏**

–í —Ä–∞–∑–¥–µ–ª–µ **Dashboards** ‚Üí **Cost**:
- –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏
- Breakdown –ø–æ –º–æ–¥–µ–ª—è–º (gemini-2.5-flash-lite, etc.)
- –°—Ç–æ–∏–º–æ—Å—Ç—å –Ω–∞ –∑–∞–ø—Ä–æ—Å
- –¢–æ–ø –¥–æ—Ä–æ–≥–∏—Ö –ø—Ä–æ–º–ø—Ç–æ–≤

### 3. **–ü–æ–∏—Å–∫ —É–∑–∫–∏—Ö –º–µ—Å—Ç**

–í —Ä–∞–∑–¥–µ–ª–µ **Analytics** ‚Üí **Latency**:
- –°—Ä–µ–¥–Ω—è—è latency –ø–æ —É–∑–ª–∞–º –≥—Ä–∞—Ñ–∞
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- Outliers (–∞–Ω–æ–º–∞–ª—å–Ω–æ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å/–±–µ–∑ RAG, —Å/–±–µ–∑ Exa

### 4. **–û—Ç–ª–∞–¥–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤**

–í —Ä–∞–∑–¥–µ–ª–µ **Prompts**:
- –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –ø—Ä–æ–º–ø—Ç–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –≤ Gemini
- –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤
- A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫

## –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å Langfuse (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –∫–≤–æ—Ç—ã):

1. –í `.env.local` –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∫–ª—é—á–∏:
   ```bash
   # LANGFUSE_PUBLIC_KEY=pk-lf-...
   # LANGFUSE_SECRET_KEY=sk-lf-...
   ```

2. –ò–ª–∏ —É–¥–∞–ª–∏—Ç–µ –∏—Ö –∏–∑ —Ñ–∞–π–ª–∞

3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏, –Ω–æ –±–µ–∑ —Å–Ω–∏–∂–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–ø—Ä–æ–≤–µ—Ä–∫–∞ `is_enabled()` –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è).

## –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### Custom scoring

–í Langfuse –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—Ü–µ–Ω–∫—É –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤:
- –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏?)
- –ü–æ–ª–Ω–æ—Ç–∞ (–≤—Å–µ –ª–∏ –∞—Å–ø–µ–∫—Ç—ã –≤–æ–ø—Ä–æ—Å–∞ —Ä–∞—Å–∫—Ä—ã—Ç—ã?)
- –¢–æ–∫—Å–∏—á–Ω–æ—Å—Ç—å, hallucinations, etc.

### Datasets & Testing

–°–æ–∑–¥–∞–π—Ç–µ –¥–∞—Ç–∞—Å–µ—Ç —Ç–∏–ø–∏—á–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Ä–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
1. –í Langfuse —Å–æ–∑–¥–∞–π—Ç–µ **Dataset**
2. –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∏–º–µ—Ä—ã: –≤–æ–ø—Ä–æ—Å ‚Üí –æ–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç
3. –ó–∞–ø—É—Å–∫–∞–π—Ç–µ —Ç–µ—Å—Ç—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
4. –°—Ä–∞–≤–Ω–∏–≤–∞–π—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

### Sessions & Users

–î–ª—è –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
- `session_id`: –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏ –±—Ä–∞—É–∑–µ—Ä–∞
- `user_id`: –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

(–¢—Ä–µ–±—É–µ—Ç –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ `main.py` –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏/–ø–µ—Ä–µ–¥–∞—á–∏ —ç—Ç–∏—Ö ID)

## Troubleshooting

**–ü—Ä–æ–±–ª–µ–º–∞**: Traces –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ Langfuse

**–†–µ—à–µ–Ω–∏—è**:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á–∏ –≤ `.env.local` (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `Langfuse tracing enabled: host=...`
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –ª–æ–≥–∞—Ö –Ω–µ—Ç –æ—à–∏–±–æ–∫ –≤–∏–¥–∞ `Failed to initialize Langfuse`
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç–µ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å cloud.langfuse.com
5. –í—ã–∑–æ–≤–∏—Ç–µ `langfuse.flush()` –≤—Ä—É—á–Ω—É—é –≤ –∫–æ–Ω—Ü–µ –∑–∞–ø—Ä–æ—Å–∞ (—É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ–¥)

**–ü—Ä–æ–±–ª–µ–º–∞**: Incomplete traces (–Ω–µ –≤—Å–µ —É–∑–ª—ã –≤–∏–¥–Ω—ã)

**–ü—Ä–∏—á–∏–Ω–∞**: LangGraph callback –º–æ–∂–µ—Ç –Ω–µ –ª–æ–≤–∏—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —É–∑–ª—ã, –µ—Å–ª–∏ –æ–Ω–∏ –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π

**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ backend –Ω–∞ –æ—à–∏–±–∫–∏, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –∏—Ö

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
2. ‚úÖ –û—Ç–∫—Ä–æ–π—Ç–µ Langfuse –∏ –∏–∑—É—á–∏—Ç–µ traces
3. ‚úÖ –ù–∞—Å—Ç—Ä–æ–π—Ç–µ alerting –Ω–∞ –¥–æ–ª–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã (>10s) –∏–ª–∏ –≤—ã—Å–æ–∫—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
4. ‚úÖ –°–æ–∑–¥–∞–π—Ç–µ dashboard —Å –∫–ª—é—á–µ–≤—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏
5. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö

–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞! üöÄ




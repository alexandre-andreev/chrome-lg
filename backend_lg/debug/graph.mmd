graph TD
  prepare_context(prepare_context)
  chunk_notes(chunk_notes)
  build_search_query(build_search_query)
  exa_search(exa_search)
  compose_prompt(compose_prompt)
  call_gemini(call_gemini)
  postprocess_answer(postprocess_answer)
  assess(assess)
  ensure_answer(ensure_answer)
  finalize(finalize)
  END(END)
  prepare_context--|chunk|-->chunk_notes
  prepare_context--|no_chunk|-->build_search_query
  chunk_notes-->build_search_query
  build_search_query--|need_search|-->exa_search
  build_search_query--|no_search|-->compose_prompt
  exa_search-->compose_prompt
  compose_prompt-->call_gemini
  call_gemini-->postprocess_answer
  postprocess_answer-->assess
  assess--|retry|-->exa_search
  assess--|continue|-->ensure_answer
  ensure_answer-->finalize
  finalize-->END
